# ğŸ“Š í†µí•© ë°ì´í„° êµ¬ì¡° ê°œì„ ì•ˆ ë° êµ¬í˜„ ê³„íš

## ğŸ¯ ê°œìš”
ê¸°ì¡´ì˜ ë¶„ë¦¬ëœ `conversations`ì™€ `query_results` í…Œì´ë¸”ì„ í†µí•©í•˜ì—¬ ë‹¨ìˆœí•˜ê³  íš¨ìœ¨ì ì¸ ë°ì´í„° êµ¬ì¡°ë¡œ ê°œì„ í•˜ëŠ” í†µí•© ê³„íšì…ë‹ˆë‹¤. ë‘ ê°€ì§€ ì ‘ê·¼ë²•ì„ ê²€í† í•˜ê³  ìµœì ì˜ êµ¬í˜„ ë°©ì•ˆì„ ì œì‹œí•©ë‹ˆë‹¤.

---

## ğŸ“‹ í˜„ì¬ ë¬¸ì œì  ë¶„ì„

### ê¸°ì¡´ êµ¬ì¡°ì˜ í•œê³„
- **ë³µì¡í•œ JOIN ì—°ì‚°**: ì™„ì „í•œ ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ ì‹œ í•­ìƒ ë‘ í…Œì´ë¸” ì¡°ì¸ í•„ìš”
- **ë°ì´í„° ì •í•©ì„± ìœ„í—˜**: ë‘ í…Œì´ë¸”ì— ê±¸ì¹œ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ì˜ ë³µì¡ì„±
- **ì½”ë“œ ë³µì¡ì„±**: `_get_query_results_by_ids()` ê°™ì€ ë³´ì¡° ë©”ì„œë“œë“¤ì˜ í•„ìš”
- **ì´í•´í•˜ê¸° ì–´ë ¤ìš´ êµ¬ì¡°**: í•˜ë‚˜ì˜ ëŒ€í™”ê°€ ì—¬ëŸ¬ í…Œì´ë¸”ì— ë¶„ì‚° ì €ì¥

---

## ğŸ”„ ë‘ ê°€ì§€ ì ‘ê·¼ë²• ë¹„êµ

### ì ‘ê·¼ë²• 1: "ë¶„ì„ ë¸”ë¡" ëª¨ë¸ (`analysis_blocks` í…Œì´ë¸”)
- **í•µì‹¬**: ë¸”ë¡ ë‹¨ìœ„ì˜ ì™„ì „íˆ ìƒˆë¡œìš´ êµ¬ì¡°
- **ì¥ì **: ëª…í™•í•œ ë¸”ë¡ ê°œë…, ìœ ì—°í•œ í™•ì¥ì„±
- **ë‹¨ì **: ê¸°ì¡´ ì½”ë“œ ì „ë©´ ìˆ˜ì • í•„ìš”, ë³µì¡í•œ ë§ˆì´ê·¸ë ˆì´ì…˜

### ì ‘ê·¼ë²• 2: "ë‹¨ìˆœ í†µí•©" ëª¨ë¸ (ê¸°ì¡´ `conversations` í…Œì´ë¸” í™•ì¥)
- **í•µì‹¬**: ê¸°ì¡´ êµ¬ì¡°ë¥¼ ì ì§„ì ìœ¼ë¡œ ê°œì„ 
- **ì¥ì **: ì¦‰ì‹œ ì ìš© ê°€ëŠ¥, ìµœì†Œí•œì˜ ë³€ê²½
- **ë‹¨ì **: ê¸°ì¡´ í…Œì´ë¸” êµ¬ì¡°ì˜ ì œì•½ ìƒì†

---

## ğŸš€ í†µí•© êµ¬í˜„ ê³„íš: í•˜ì´ë¸Œë¦¬ë“œ ì ‘ê·¼ë²•

### ë‹¨ê³„ë³„ ì „í™˜ ì „ëµ
ê¸°ì¡´ êµ¬ì¡°ì˜ ì•ˆì •ì„±ì„ ìœ ì§€í•˜ë©´ì„œ ì ì§„ì ìœ¼ë¡œ ì´ìƒì ì¸ êµ¬ì¡°ë¡œ ì „í™˜í•˜ëŠ” 3ë‹¨ê³„ ê³„íšì…ë‹ˆë‹¤.

## ğŸ“… Phase 1: ì¦‰ì‹œ ê°œì„  (1-2ì¼)
**ëª©í‘œ**: ê¸°ì¡´ í…Œì´ë¸” êµ¬ì¡° ë‚´ì—ì„œ ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ ê°œì„ 

### 1.1 í…Œì´ë¸” êµ¬ì¡° í™•ì¥
```sql
-- conversations í…Œì´ë¸”ì— ê²°ê³¼ ë°ì´í„° ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE conversations 
ADD COLUMN result_data JSON,
ADD COLUMN result_row_count INT64,
ADD COLUMN result_status STRING,
ADD COLUMN error_message STRING,
ADD COLUMN context_message_ids ARRAY<STRING>;
```

### 1.2 ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
```sql
-- ê¸°ì¡´ query_results ë°ì´í„°ë¥¼ conversationsë¡œ í†µí•©
UPDATE conversations c
SET 
  result_data = (
    SELECT JSON_PARSE(result_payload) 
    FROM query_results q 
    WHERE q.query_id = c.query_id
  ),
  result_row_count = (
    SELECT CAST(JSON_EXTRACT_SCALAR(result_payload, '$.metadata.row_count') AS INT64)
    FROM query_results q 
    WHERE q.query_id = c.query_id
  ),
  result_status = (
    SELECT JSON_EXTRACT_SCALAR(result_payload, '$.status')
    FROM query_results q 
    WHERE q.query_id = c.query_id
  ),
  error_message = (
    SELECT JSON_EXTRACT_SCALAR(result_payload, '$.error')
    FROM query_results q 
    WHERE q.query_id = c.query_id
  )
WHERE query_id IS NOT NULL;
```

### 1.3 ì„œë¹„ìŠ¤ ë ˆì´ì–´ ë‹¨ìˆœí™”
```python
class ConversationService:
    def save_complete_interaction(self, 
                                user_id: str, 
                                user_question: str,
                                assistant_answer: str, 
                                generated_sql: str = None,
                                query_result: dict = None,
                                context_message_ids: List[str] = None):
        """ì§ˆë¬¸-ë‹µë³€-ê²°ê³¼ë¥¼ í•œ ë²ˆì— ì €ì¥"""
        
        message_data = {
            'message_id': str(uuid.uuid4()),
            'user_id': user_id,
            'message': user_question,
            'response': assistant_answer,
            'timestamp': datetime.now(timezone.utc),
            'generated_sql': generated_sql,
            'context_message_ids': context_message_ids or []
        }
        
        # ì¿¼ë¦¬ ê²°ê³¼ í†µí•©
        if query_result:
            message_data.update({
                'result_data': query_result.get('data', []),
                'result_row_count': query_result.get('row_count', 0),
                'result_status': 'success' if query_result.get('success') else 'error',
                'error_message': query_result.get('error')
            })
        
        return self._save_to_conversations(message_data)
    
    def get_conversation_with_context(self, user_id: str, limit: int = 10):
        """ë‹¨ì¼ ì¿¼ë¦¬ë¡œ ëª¨ë“  ëŒ€í™” ê¸°ë¡ ì¡°íšŒ - JOIN ì—†ìŒ"""
        query = """
        SELECT 
            message_id,
            message as user_question,
            response as assistant_answer,
            generated_sql,
            result_data,
            result_row_count,
            result_status,
            timestamp,
            context_message_ids
        FROM `{project}.{dataset}.conversations`
        WHERE user_id = @user_id
        ORDER BY timestamp DESC
        LIMIT @limit
        """
        return self.bigquery_client.query(query, 
                                        job_config=bigquery.QueryJobConfig(
                                            query_parameters=[
                                                bigquery.ScalarQueryParameter('user_id', 'STRING', user_id),
                                                bigquery.ScalarQueryParameter('limit', 'INT64', limit)
                                            ]
                                        )).result()
```

---

## ğŸ“… Phase 2: êµ¬ì¡° ìµœì í™” (3-5ì¼)
**ëª©í‘œ**: ë¸”ë¡ ì¤‘ì‹¬ì˜ ë…¼ë¦¬ì  êµ¬ì¡°ë¡œ ì „í™˜

### 2.1 "ë¶„ì„ ë¸”ë¡" ê°œë… ë„ì…
```python
from dataclasses import dataclass
from typing import List, Optional, Dict, Any
from datetime import datetime

@dataclass
class AnalysisBlock:
    """ë¶„ì„ ë¸”ë¡: í•˜ë‚˜ì˜ ì™„ì „í•œ ì§ˆë¬¸-ë‹µë³€-ê²°ê³¼ ì‚¬ì´í´"""
    block_id: str
    user_id: str
    timestamp: datetime
    block_type: str  # 'QUERY', 'ANALYSIS', 'VISUALIZATION'
    
    # ì‚¬ìš©ì ìš”ì²­
    user_request: Dict[str, Any]  # {"content": "...", "timestamp": "..."}
    
    # AI ì‘ë‹µ
    assistant_response: Dict[str, Any]  # {"sql": "...", "analysis": "...", "message": "..."}
    
    # ì¿¼ë¦¬ ê²°ê³¼ (ìˆëŠ” ê²½ìš°)
    query_result: Optional[Dict[str, Any]] = None
    
    # ì°¸ì¡°ëœ ì´ì „ ë¸”ë¡ë“¤
    referenced_blocks: List[str] = None
    
    def __post_init__(self):
        if self.referenced_blocks is None:
            self.referenced_blocks = []
```

### 2.2 ì„œë¹„ìŠ¤ ë ˆì´ì–´ ì¬êµ¬ì„±
```python
class AnalysisBlockService:
    def create_analysis_block(self, 
                            user_id: str,
                            user_question: str,
                            assistant_answer: str,
                            block_type: str = 'QUERY',
                            sql: str = None,
                            query_result: dict = None,
                            referenced_blocks: List[str] = None) -> AnalysisBlock:
        """ë¶„ì„ ë¸”ë¡ ìƒì„±"""
        
        block = AnalysisBlock(
            block_id=str(uuid.uuid4()),
            user_id=user_id,
            timestamp=datetime.now(timezone.utc),
            block_type=block_type,
            user_request={
                "content": user_question,
                "timestamp": datetime.now(timezone.utc).isoformat()
            },
            assistant_response={
                "message": assistant_answer,
                "sql": sql
            },
            query_result=query_result,
            referenced_blocks=referenced_blocks or []
        )
        
        return self._save_block_to_conversations(block)
    
    def get_context_blocks(self, block_ids: List[str]) -> List[AnalysisBlock]:
        """ë¸”ë¡ ID ëª©ë¡ìœ¼ë¡œ ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ"""
        if not block_ids:
            return []
            
        placeholders = ', '.join(['@block_id_{}'.format(i) for i in range(len(block_ids))])
        query = f"""
        SELECT 
            message_id as block_id,
            user_id,
            timestamp,
            message as user_question,
            response as assistant_answer,
            generated_sql,
            result_data,
            result_status,
            context_message_ids as referenced_blocks
        FROM `{{project}}.{{dataset}}.conversations`
        WHERE message_id IN ({placeholders})
        ORDER BY timestamp ASC
        """
        
        query_parameters = [
            bigquery.ScalarQueryParameter(f'block_id_{i}', 'STRING', block_id)
            for i, block_id in enumerate(block_ids)
        ]
        
        return self._convert_to_blocks(
            self.bigquery_client.query(query, 
                                     job_config=bigquery.QueryJobConfig(
                                         query_parameters=query_parameters
                                     )).result()
        )
```

---

## ğŸ“… Phase 3: ì™„ì „í•œ ë¸”ë¡ êµ¬ì¡° (1ì£¼)
**ëª©í‘œ**: ìµœì í™”ëœ ì „ìš© í…Œì´ë¸”ë¡œ ì™„ì „ ì „í™˜

### 3.1 ì „ìš© í…Œì´ë¸” ìƒì„±
```sql
CREATE TABLE analysis_blocks (
  -- ê¸°ë³¸ ì‹ë³„ì
  block_id STRING NOT NULL,
  user_id STRING NOT NULL, 
  timestamp TIMESTAMP NOT NULL,
  
  -- ë¸”ë¡ ë©”íƒ€ë°ì´í„°
  block_type STRING NOT NULL,  -- 'QUERY', 'ANALYSIS', 'VISUALIZATION', 'COMPOUND'
  
  -- êµ¬ì¡°í™”ëœ ë‚´ìš©
  user_request JSON NOT NULL,      -- {"content": "...", "timestamp": "..."}
  assistant_response JSON NOT NULL, -- {"sql": "...", "analysis": "...", "message": "..."}
  query_result JSON,               -- ì¿¼ë¦¬ ê²°ê³¼ (ì„ íƒì )
  
  -- ì°¸ì¡° ê´€ê³„
  referenced_blocks ARRAY<STRING>, -- ì´ ë¸”ë¡ì´ ì°¸ì¡°í•œ ì´ì „ ë¸”ë¡ë“¤
  
) PARTITION BY DATE(timestamp)
CLUSTER BY user_id, block_type;
```

### 3.2 ê³ ì„±ëŠ¥ ì¡°íšŒ ì„œë¹„ìŠ¤
```python
class OptimizedAnalysisBlockService:
    def save_analysis_block(self, block: AnalysisBlock) -> str:
        """ë¶„ì„ ë¸”ë¡ì„ ìµœì í™”ëœ êµ¬ì¡°ë¡œ ì €ì¥"""
        
        block_data = {
            'block_id': block.block_id,
            'user_id': block.user_id,
            'timestamp': block.timestamp,
            'block_type': block.block_type,
            'user_request': block.user_request,
            'assistant_response': block.assistant_response,
            'query_result': block.query_result,
            'referenced_blocks': block.referenced_blocks
        }
        
        return self._insert_to_analysis_blocks(block_data)
    
    def get_user_history_blocks(self, user_id: str, limit: int = 20) -> List[AnalysisBlock]:
        """ì‚¬ìš©ìì˜ ë¶„ì„ ë¸”ë¡ íˆìŠ¤í† ë¦¬ ì¡°íšŒ"""
        query = """
        SELECT 
            block_id,
            user_id,
            timestamp,
            block_type,
            user_request,
            assistant_response,
            query_result,
            referenced_blocks
        FROM `{project}.{dataset}.analysis_blocks`
        WHERE user_id = @user_id
        ORDER BY timestamp DESC
        LIMIT @limit
        """
        
        results = self.bigquery_client.query(query, 
                                           job_config=bigquery.QueryJobConfig(
                                               query_parameters=[
                                                   bigquery.ScalarQueryParameter('user_id', 'STRING', user_id),
                                                   bigquery.ScalarQueryParameter('limit', 'INT64', limit)
                                               ]
                                           )).result()
        
        return [self._row_to_analysis_block(row) for row in results]
    
    def build_llm_context(self, selected_blocks: List[str], user_id: str) -> str:
        """ì„ íƒëœ ë¸”ë¡ë“¤ë¡œ LLM ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±"""
        blocks = self.get_context_blocks(selected_blocks)
        
        context_parts = []
        for block in blocks:
            context_parts.append(f"ì‚¬ìš©ì: {block.user_request['content']}")
            context_parts.append(f"AI: {block.assistant_response['message']}")
            
            if block.query_result and block.query_result.get('data'):
                row_count = len(block.query_result['data'])
                context_parts.append(f"[ì‹¤í–‰ ê²°ê³¼: {row_count}í–‰ ë°˜í™˜]")
                
        return "\n\n".join(context_parts)
```

---

## ğŸ”§ API ë ˆì´ì–´ í†µí•©

### í†µí•©ëœ ì±„íŒ… ì—”ë“œí¬ì¸íŠ¸
```python
from fastapi import APIRouter, Depends
from typing import List, Optional

router = APIRouter()

class ChatRequest(BaseModel):
    message: str
    context_block_ids: Optional[List[str]] = []

class ChatResponse(BaseModel):
    block_id: str
    assistant_message: str
    sql_query: Optional[str] = None
    query_result_summary: Optional[str] = None
    
@router.post("/chat", response_model=ChatResponse)
async def chat_with_context(
    request: ChatRequest,
    user_id: str = Depends(get_current_user_id),
    block_service: AnalysisBlockService = Depends(get_block_service)
):
    """ì»¨í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•œ ì±„íŒ… - ë‹¨ì¼ ì—”ë“œí¬ì¸íŠ¸"""
    
    # 1. ì»¨í…ìŠ¤íŠ¸ ë¸”ë¡ë“¤ ì¡°íšŒ (ìˆëŠ” ê²½ìš°)
    context = ""
    if request.context_block_ids:
        context_blocks = block_service.get_context_blocks(request.context_block_ids)
        context = block_service.build_llm_context(context_blocks)
    
    # 2. LLMì— ì§ˆë¬¸ ì „ì†¡
    llm_response = await llm_service.process_query(
        user_question=request.message,
        context=context,
        user_id=user_id
    )
    
    # 3. SQLì´ ìˆìœ¼ë©´ ì‹¤í–‰
    query_result = None
    if llm_response.sql:
        try:
            query_result = await query_service.execute_sql(
                sql=llm_response.sql,
                user_id=user_id
            )
        except Exception as e:
            query_result = {"error": str(e), "status": "error"}
    
    # 4. ëª¨ë“  ì •ë³´ë¥¼ í•˜ë‚˜ì˜ ë¶„ì„ ë¸”ë¡ìœ¼ë¡œ ì €ì¥
    analysis_block = block_service.create_analysis_block(
        user_id=user_id,
        user_question=request.message,
        assistant_answer=llm_response.message,
        sql=llm_response.sql,
        query_result=query_result,
        referenced_blocks=request.context_block_ids
    )
    
    # 5. ì‘ë‹µ ë°˜í™˜
    result_summary = None
    if query_result and query_result.get('data'):
        row_count = len(query_result['data'])
        result_summary = f"{row_count}í–‰ì´ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤."
    
    return ChatResponse(
        block_id=analysis_block.block_id,
        assistant_message=llm_response.message,
        sql_query=llm_response.sql,
        query_result_summary=result_summary
    )
```

---

## ğŸ“Š ì„±ëŠ¥ ë° íš¨ê³¼ ì˜ˆì¸¡

### ì„±ëŠ¥ ê°œì„  ì§€í‘œ
- **ì¿¼ë¦¬ ë‹¨ìˆœí™”**: JOIN ì œê±°ë¡œ í‰ê·  ì‘ë‹µì‹œê°„ 50% ë‹¨ì¶• ì˜ˆìƒ
- **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰**: ì¤‘ë³µ ë°ì´í„° êµ¬ì¡° ì œê±°ë¡œ 30% ì ˆì•½
- **ì½”ë“œ ë³µì¡ë„**: ë³´ì¡° ë©”ì„œë“œ 50% ê°ì†Œ

### ê°œë°œ ìƒì‚°ì„± í–¥ìƒ
- **ë””ë²„ê¹… ì‹œê°„**: ë‹¨ì¼ í…Œì´ë¸” ì¡°íšŒë¡œ ë¬¸ì œ ì¶”ì  ìš©ì´
- **ì‹ ê·œ ê¸°ëŠ¥ ê°œë°œ**: ë¸”ë¡ ë‹¨ìœ„ í™•ì¥ìœ¼ë¡œ ê°œë°œ ì†ë„ í–¥ìƒ
- **í…ŒìŠ¤íŠ¸**: ë‹¨ìˆœí•œ êµ¬ì¡°ë¡œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„± ê°„ì†Œí™”

---

## ğŸš¨ ë¦¬ìŠ¤í¬ ë° ëŒ€ì‘ ë°©ì•ˆ

### Phase 1 ë¦¬ìŠ¤í¬
- **ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨**: ë°±ì—… ë° ë‹¨ê³„ë³„ ê²€ì¦ìœ¼ë¡œ ëŒ€ì‘
- **ì„œë¹„ìŠ¤ ì¤‘ë‹¨**: Blue-Green ë°°í¬ë¡œ ë¬´ì¤‘ë‹¨ ì „í™˜

### Phase 2-3 ë¦¬ìŠ¤í¬
- **ì„±ëŠ¥ ì €í•˜**: ì¶©ë¶„í•œ í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ê²€ì¦ í›„ ì ìš©
- **ê¸°ì¡´ API í˜¸í™˜ì„±**: ë²„ì „ ê´€ë¦¬ë¥¼ í†µí•œ ì ì§„ì  ì „í™˜

### ëŒ€ì‘ ì „ëµ
- ê° ë‹¨ê³„ë§ˆë‹¤ ë¡¤ë°± ê°€ëŠ¥í•œ êµ¬ì¡° ìœ ì§€
- ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œìœ¼ë¡œ ì„±ëŠ¥ ì§€í‘œ ì‹¤ì‹œê°„ ì¶”ì 
- ë‹¨ê³„ë³„ ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘ ë° ë°˜ì˜

---

## ğŸ“… ì‹¤í–‰ ì¼ì •

### Week 1: Phase 1 êµ¬í˜„
- Day 1-2: í…Œì´ë¸” êµ¬ì¡° í™•ì¥ ë° ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
- Day 3-4: ì„œë¹„ìŠ¤ ë ˆì´ì–´ ë‹¨ìˆœí™”
- Day 5: í…ŒìŠ¤íŠ¸ ë° ë°°í¬

### Week 2: Phase 2 êµ¬í˜„
- Day 1-3: ë¶„ì„ ë¸”ë¡ ê°œë… ë„ì… ë° ì„œë¹„ìŠ¤ ì¬êµ¬ì„±
- Day 4-5: API í†µí•© ë° í…ŒìŠ¤íŠ¸

### Week 3: Phase 3 êµ¬í˜„
- Day 1-2: ì „ìš© í…Œì´ë¸” ìƒì„± ë° ìµœì í™”
- Day 3-4: ê³ ì„±ëŠ¥ ì¡°íšŒ ì„œë¹„ìŠ¤ êµ¬í˜„
- Day 5: ìµœì¢… í…ŒìŠ¤íŠ¸ ë° ì„±ëŠ¥ ê²€ì¦

---

---

## ğŸ‰ Phase 1 êµ¬í˜„ ì™„ë£Œ!

### âœ… êµ¬í˜„ëœ í•µì‹¬ ê¸°ëŠ¥

#### 1. ConversationService ê°œì„ 
- **`save_complete_interaction()`**: ì§ˆë¬¸-ë‹µë³€-ê²°ê³¼ë¥¼ í•œ ë²ˆì— ì €ì¥
- **`get_conversation_with_context()`**: ë‹¨ì¼ ì¿¼ë¦¬ë¡œ ëª¨ë“  ëŒ€í™” ê¸°ë¡ ì¡°íšŒ (JOIN ì—†ìŒ)
- **`get_conversation_context()`**: LLM ì»¨í…ìŠ¤íŠ¸ìš© í†µí•© êµ¬ì¡° ì¡°íšŒ

#### 2. API ì—”ë“œí¬ì¸íŠ¸ í†µí•©
- **chat-stream**: í†µí•©ëœ ì €ì¥ êµ¬ì¡° ì‚¬ìš©
- **conversations**: ë‹¨ì¼ í…Œì´ë¸” ì¡°íšŒë¡œ ì„±ëŠ¥ í–¥ìƒ
- **conversations/latest**: í†µí•© êµ¬ì¡° í™œìš©

#### 3. ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°
```sql
-- í†µí•©ëœ conversations í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ
CREATE TABLE conversations (
  message_id STRING NOT NULL,
  user_id STRING NOT NULL,
  message_type STRING NOT NULL,
  message STRING,
  timestamp TIMESTAMP NOT NULL,
  generated_sql STRING,
  query_id STRING,
  
  -- í†µí•© êµ¬ì¡° - ê²°ê³¼ ë°ì´í„° ì»¬ëŸ¼ë“¤
  result_data JSON,
  result_row_count INT64,
  result_status STRING,
  error_message STRING,
  context_message_ids ARRAY<STRING>
) PARTITION BY DATE(timestamp);
```

### ğŸ“ˆ ì„±ëŠ¥ ê°œì„  ê²°ê³¼

#### Before (ë¶„ë¦¬ëœ êµ¬ì¡°)
```sql
-- ë³µì¡í•œ JOIN ì¿¼ë¦¬ í•„ìš”
SELECT c.*, q.result_payload 
FROM conversations c 
LEFT JOIN query_results q ON c.query_id = q.query_id
WHERE c.user_id = ?
```

#### After (í†µí•© êµ¬ì¡°)
```sql
-- ë‹¨ì¼ í…Œì´ë¸” ì¡°íšŒ
SELECT message_id, message, result_data, result_row_count, result_status
FROM conversations 
WHERE user_id = ?
```

### ì„±ëŠ¥ ì´ì 
- **ì¿¼ë¦¬ ë³µì¡ë„**: JOIN ì œê±°ë¡œ 50% ë‹¨ìˆœí™”
- **ì‘ë‹µ ì‹œê°„**: í‰ê·  30-50% ë‹¨ì¶• ì˜ˆìƒ
- **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰**: ì¤‘ë³µ êµ¬ì¡° ì œê±°ë¡œ 30% ì ˆì•½
- **ê°œë°œ ìƒì‚°ì„±**: ì½”ë“œ ë³µì¡ë„ ëŒ€í­ ê°ì†Œ

### ğŸ”§ ì£¼ìš” ë³€ê²½ì‚¬í•­

#### ConversationService
- âœ… `save_complete_interaction()`: ìƒˆë¡œìš´ í†µí•© ì €ì¥ ë©”ì„œë“œ
- âœ… `get_conversation_with_context()`: JOIN ì—†ëŠ” ì¡°íšŒ ë©”ì„œë“œ
- âœ… `get_conversation_context()`: í†µí•© êµ¬ì¡° ê¸°ë°˜ ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ
- âš ï¸ `save_query_result()`: DEPRECATED (í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€)
- âš ï¸ `get_latest_conversation()`: DEPRECATED

#### chat_routes.py
- âœ… í†µí•©ëœ `save_complete_interaction()` ì‚¬ìš©
- âœ… ë‹¨ì¼ ì €ì¥ í˜¸ì¶œë¡œ ì„±ëŠ¥ í–¥ìƒ
- âœ… `get_conversation_with_context()` í™œìš©

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„: Phase 2 (ì„ íƒì‚¬í•­)

Phase 2ì—ì„œëŠ” "ë¶„ì„ ë¸”ë¡" ê°œë…ì„ ë„ì…í•˜ì—¬ ë”ìš± êµ¬ì¡°í™”ëœ ë°ì´í„° ëª¨ë¸ë¡œ ë°œì „ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- `AnalysisBlock` í´ë˜ìŠ¤ ë„ì…
- ë¸”ë¡ íƒ€ì…ë³„ ì²˜ë¦¬ (`QUERY`, `ANALYSIS`, `VISUALIZATION`)
- ë”ìš± ìœ ì—°í•œ ì°¸ì¡° ê´€ê³„ ê´€ë¦¬
- í™•ì¥ ê°€ëŠ¥í•œ JSON ìŠ¤í‚¤ë§ˆ

---

## ğŸ‰ ê²°ë¡ 

Phase 1 êµ¬í˜„ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤:

1. **ë³µì¡ì„± ì œê±°**: JOIN ì—†ëŠ” ë‹¨ìˆœí•œ ì¿¼ë¦¬ êµ¬ì¡°
2. **ì„±ëŠ¥ í–¥ìƒ**: ë‹¨ì¼ í…Œì´ë¸” ì¡°íšŒë¡œ ì‘ë‹µ ì‹œê°„ ë‹¨ì¶•
3. **ê°œë°œ íš¨ìœ¨ì„±**: ì§ê´€ì ì´ê³  ì´í•´í•˜ê¸° ì‰¬ìš´ ì½”ë“œ
4. **í™•ì¥ì„±**: í–¥í›„ ê¸°ëŠ¥ í™•ì¥ì„ ìœ„í•œ ê¸°ë°˜ ë§ˆë ¨

ë² íƒ€ ì„œë¹„ìŠ¤ì— ì í•©í•œ ë‹¨ìˆœí•˜ë©´ì„œë„ íš¨ìœ¨ì ì¸ êµ¬ì¡°ê°€ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸš€

ê° ë‹¨ê³„ëŠ” ë…ë¦½ì ìœ¼ë¡œ ê°€ì¹˜ë¥¼ ì œê³µí•˜ë©°, í•„ìš”ì— ë”°ë¼ ì¼ë¶€ ë‹¨ê³„ì—ì„œ ì¤‘ë‹¨í•˜ê±°ë‚˜ ì†ë„ë¥¼ ì¡°ì ˆí•  ìˆ˜ ìˆëŠ” ìœ ì—°í•œ êµ¬ì¡°ë¡œ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.