rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 화이트리스트 컬렉션 - 이메일 기반 단순화
    match /whitelist/{email} {
      // 사용자는 자신의 이메일로 된 화이트리스트만 읽기 가능
      allow read: if request.auth != null && request.auth.token.email == email;
      // 관리자는 모든 화이트리스트 관리 가능
      allow read, write: if request.auth != null && 
                          request.auth.token.admin == true;
    }
    
    // 사용자 컬렉션 - 이메일 기반 접근 제어
    match /users/{email} {
      // 사용자는 자신의 이메일로 된 데이터만 읽기/쓰기 가능
      allow read, write: if request.auth != null && request.auth.token.email == email;
      
      // 사용자의 conversations 서브컬렉션 (이메일 기반)
      match /conversations/{conversationId} {
        // 사용자는 자신의 이메일에 속한 대화만 읽기/쓰기 가능
        allow read, write: if request.auth != null && request.auth.token.email == email;
        
        // 대화 데이터 유효성 검증
        allow create: if request.auth != null && 
                         request.auth.token.email == email &&
                         request.resource.data.user_id == email &&
                         request.resource.data.block_id is string &&
                         request.resource.data.timestamp is timestamp &&
                         request.resource.data.block_type in ['QUERY', 'ANALYSIS', 'METADATA', 'GUIDE'] &&
                         request.resource.data.user_request is string &&
                         request.resource.data.status in ['pending', 'processing', 'completed', 'failed'];
        
        // 업데이트 시 user_id(이메일) 변경 금지
        allow update: if request.auth != null && 
                         request.auth.token.email == email &&
                         request.resource.data.user_id == resource.data.user_id;
      }
    }
    
    // 기본적으로 모든 다른 접근 거부
    match /{document=**} {
      allow read, write: if false;
    }
  }
}