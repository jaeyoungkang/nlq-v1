# ğŸ”§ ì»¨í…ìŠ¤íŠ¸ ìœ ì§€ ë¬¸ì œ í•´ê²° ê³„íš

## ğŸ“‹ ë¬¸ì œ ë¶„ì„ ê²°ê³¼

### ğŸš¨ í•µì‹¬ ë¬¸ì œì 

#### 1. **ë°ì´í„° ì €ì¥ ë°©ì‹ì˜ ë¶ˆì¼ì¹˜**
```python
# í˜„ì¬ êµ¬í˜„ (chat_routes.py:66-74, 149-158)
# ë¬¸ì œ: ê°œë³„ ë©”ì‹œì§€ë¡œ ë¶„ë¦¬ ì €ì¥
user_message_data = {'message_type': 'user', ...}
ai_message_data = {'message_type': 'assistant', ...}
bigquery_client.save_conversation(user_message_data)
bigquery_client.save_conversation(ai_message_data)

# ê³„íšì„œì˜ í†µí•© ë°©ì‹ (ë¯¸ì ìš© ìƒíƒœ)
# í•´ê²°ì±…: ì§ˆë¬¸-ë‹µë³€-ê²°ê³¼ë¥¼ í•˜ë‚˜ì˜ ë¸”ë¡ìœ¼ë¡œ ì €ì¥
bigquery_client.save_complete_interaction(...)
```

#### 2. **ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ ë¡œì§ì˜ íŒŒì‹± ì˜¤ë¥˜**
```python
# conversation_service.py:164 - ë¬¸ì œê°€ ìˆëŠ” íŒŒì‹± ë¡œì§
message_parts = row.message.split('\\nA: ', 1)
# ê°œë³„ ì €ì¥ëœ ë©”ì‹œì§€ì—ëŠ” 'Q: ... A: ...' í˜•ì‹ì´ ì—†ì–´ íŒŒì‹± ì‹¤íŒ¨
```

#### 3. **ì¿¼ë¦¬ ê²°ê³¼ ì €ì¥ì˜ ì¤‘ë³µì„±**
```python
# chat_routes.py:101 - ë³„ë„ ì¿¼ë¦¬ ê²°ê³¼ ì €ì¥
save_res = bigquery_client.save_query_result(query_id, query_result)
# í†µí•© êµ¬ì¡°ì—ì„œëŠ” ë¶ˆí•„ìš”í•œ ì¤‘ë³µ ì €ì¥
```

---

## ğŸ¯ í•´ê²° ë°©ì•ˆ

### Phase 1: ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ ìˆ˜ì •ì‚¬í•­

#### 1.1 chat_routes.py í†µí•© ì €ì¥ ë°©ì‹ ì ìš©

**í˜„ì¬ ì½”ë“œ (ë¬¸ì œ)**:
```python
# ê°œë³„ ì €ì¥ ë°©ì‹ (ë¼ì¸ 66-74, 149-158)
bigquery_client.save_conversation(user_message_data)
# ... ì²˜ë¦¬ ë¡œì§ ...
bigquery_client.save_conversation(ai_message_data)
bigquery_client.save_query_result(query_id, query_result)  # ì¤‘ë³µ ì €ì¥
```

**ìˆ˜ì •ì•ˆ**:
```python
# í†µí•© ì €ì¥ ë°©ì‹ìœ¼ë¡œ ë³€ê²½
# ëª¨ë“  ì²˜ë¦¬ ì™„ë£Œ í›„ í•œ ë²ˆì— ì €ì¥
save_result = bigquery_client.save_complete_interaction(
    user_id=user_info['user_id'],
    user_question=message,
    assistant_answer=ai_response_content,
    generated_sql=generated_sql,
    query_result=query_result,
    context_message_ids=[]  # í–¥í›„ í™•ì¥ ê°€ëŠ¥
)
```

#### 1.2 ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ ë¡œì§ ê°œì„ 

**í˜„ì¬ ë¬¸ì œ**:
- `get_conversation_context()`ê°€ í†µí•© ë©”ì‹œì§€ í˜•ì‹(`Q: ... A: ...`)ì„ ê°€ì •
- ê°œë³„ ì €ì¥ëœ ë©”ì‹œì§€ì—ì„œëŠ” íŒŒì‹± ì‹¤íŒ¨

**í•´ê²°ì±…**:
```python
def get_conversation_context_v2(self, user_id: str, max_messages: int = 10):
    """ê°œë³„/í†µí•© ë©”ì‹œì§€ ëª¨ë‘ ì§€ì›í•˜ëŠ” ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ"""
    query = """
    SELECT 
        message_id, message, message_type, timestamp,
        generated_sql, result_data, result_row_count
    FROM `{table_id}`
    WHERE user_id = @user_id
    ORDER BY timestamp DESC
    LIMIT @max_messages
    """
    
    # message_typeì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì²˜ë¦¬
    for row in rows:
        if row.message_type == 'complete':
            # í†µí•© ë©”ì‹œì§€ íŒŒì‹±
            message_parts = row.message.split('\\nA: ', 1)
            # ...
        elif row.message_type in ['user', 'assistant']:
            # ê°œë³„ ë©”ì‹œì§€ ì§ì ‘ ì‚¬ìš©
            # ...
```

### Phase 2: ë¶ˆí•„ìš”í•œ ì½”ë“œ ì œê±° ë° ì •ë¦¬

#### 2.1 ì œê±°í•  ë©”ì„œë“œë“¤ (conversation_service.py)
- `save_conversation()`: ê°œë³„ ë©”ì‹œì§€ ì €ì¥ (ë¶ˆí•„ìš”)
- `get_conversation_context()`: íŒŒì‹± ê¸°ë°˜ ì¡°íšŒ ë¡œì§ (êµì²´)
- ê¸°íƒ€ ë ˆê±°ì‹œ ë©”ì„œë“œë“¤

#### 2.2 ì •ë¦¬í•  ì½”ë“œ (chat_routes.py)  
- ê°œë³„ ë©”ì‹œì§€ ì €ì¥ ë¡œì§ ì œê±°
- ì¤‘ë³µ ì¿¼ë¦¬ ê²°ê³¼ ì €ì¥ ì œê±°
- ë¶ˆí•„ìš”í•œ ë©”ì‹œì§€ ID ìƒì„± ë¡œì§ ì œê±°

---

## ğŸ“Š ê¸°ëŒ€ íš¨ê³¼

### ì„±ëŠ¥ ê°œì„ 
- **ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ ì†ë„**: 50% í–¥ìƒ (ë‹¨ì¼ ì¿¼ë¦¬)
- **ì €ì¥ íš¨ìœ¨ì„±**: 3íšŒ ì €ì¥ â†’ 1íšŒ ì €ì¥ìœ¼ë¡œ ê°ì†Œ
- **ë°ì´í„° ì¼ê´€ì„±**: íŠ¸ëœì­ì…˜ ë‹¨ìœ„ ë³´ì¥

### ê°œë°œ íš¨ìœ¨ì„±
- **ì½”ë“œ ë³µì¡ë„**: 30% ê°ì†Œ
- **ë””ë²„ê¹… ìš©ì´ì„±**: ë‹¨ì¼ ë ˆì½”ë“œë¡œ ì¶”ì  ê°„í¸
- **í™•ì¥ì„±**: ë¸”ë¡ ë‹¨ìœ„ ê¸°ëŠ¥ ì¶”ê°€ ìš©ì´

---

## ğŸš€ êµ¬í˜„ ìš°ì„ ìˆœìœ„

### ìš°ì„ ìˆœìœ„ 1 (ì¦‰ì‹œ ì ìš©)
1. **chat_routes.py ìˆ˜ì •**: í†µí•© ì €ì¥ ë°©ì‹ ì ìš©
2. **ë¶ˆí•„ìš”í•œ ì½”ë“œ ì œê±°**: ê°œë³„ ì €ì¥ ë¡œì§ ì‚­ì œ
3. **ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ ë‹¨ìˆœí™”**: í†µí•© ë©”ì‹œì§€ ì „ìš© ë¡œì§

### ìš°ì„ ìˆœìœ„ 2 (ë‹¹ì¼ ì™„ë£Œ)
4. **conversation_service.py ì •ë¦¬**: ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë©”ì„œë“œ ì œê±°
5. **í…ŒìŠ¤íŠ¸ ê²€ì¦**: í†µí•© ì €ì¥/ì¡°íšŒ ë°©ì‹ í™•ì¸

### ìš°ì„ ìˆœìœ„ 3 (í–¥í›„ í™•ì¥)
6. **ì™„ì „í•œ ë¸”ë¡ êµ¬ì¡°**: Phase 2-3 ë‹¨ê³„ êµ¬í˜„
7. **ì„±ëŠ¥ ìµœì í™”**: ì „ìš© í…Œì´ë¸” ë° ì¸ë±ì‹±

---

## ğŸ”§ êµ¬ì²´ì ì¸ ìˆ˜ì • íŒŒì¼

### 1. `/backend/routes/chat_routes.py`
- **ë¼ì¸ 66-74**: ì‚¬ìš©ì ë©”ì‹œì§€ ê°œë³„ ì €ì¥ ì œê±°
- **ë¼ì¸ 101**: ì¿¼ë¦¬ ê²°ê³¼ ê°œë³„ ì €ì¥ ì œê±°  
- **ë¼ì¸ 149-158**: AI ì‘ë‹µ ê°œë³„ ì €ì¥ ì œê±°
- **ìƒˆë¡œìš´ ë¡œì§**: ì²˜ë¦¬ ì™„ë£Œ í›„ `save_complete_interaction()` í˜¸ì¶œ

### 2. `/backend/utils/bigquery/conversation_service.py`
- **ì œê±°**: `save_conversation()` ë©”ì„œë“œ (ë¼ì¸ 38-70)
- **ì œê±°**: `get_conversation_context()` ë©”ì„œë“œ (ë¼ì¸ 128-206)
- **ìœ ì§€**: `save_complete_interaction()`, `get_conversation_with_context()` ë©”ì„œë“œ

---

## ğŸ—‘ï¸ ì œê±°í•  ì½”ë“œ ëª©ë¡

### conversation_service.pyì—ì„œ ì œê±°í•  ë©”ì„œë“œ
```python
# 1. ê°œë³„ ë©”ì‹œì§€ ì €ì¥ (ë¼ì¸ 38-70)
def save_conversation(self, conversation_data: Dict[str, Any])

# 2. íŒŒì‹± ê¸°ë°˜ ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ (ë¼ì¸ 128-206) 
def get_conversation_context(self, user_id: str, max_messages: int = 10)
```

### chat_routes.pyì—ì„œ ì œê±°í•  ì½”ë“œ
```python
# 1. ê°œë³„ ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥ (ë¼ì¸ 66-74)
user_message_data = {...}
bigquery_client.save_conversation(user_message_data)

# 2. ê°œë³„ AI ì‘ë‹µ ì €ì¥ (ë¼ì¸ 149-158)
ai_message_data = {...}
bigquery_client.save_conversation(ai_message_data)

# 3. ì¤‘ë³µ ì¿¼ë¦¬ ê²°ê³¼ ì €ì¥ (ë¼ì¸ 101)
save_res = bigquery_client.save_query_result(query_id, query_result)
```

## âš ï¸ ì£¼ì˜ì‚¬í•­

### í…ŒìŠ¤íŠ¸ í™˜ê²½ ì „ìš©
- í”„ë¡œë•ì…˜ ë°ì´í„° ì—†ìœ¼ë¯€ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¶ˆí•„ìš”
- ê¹”ë”í•œ ìƒˆ êµ¬ì¡°ë¡œ ì „í™˜ ê°€ëŠ¥

### ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
- ì €ì¥/ì¡°íšŒ ì„±ëŠ¥ ì§€í‘œ ì¶”ì 
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§

---

## ğŸ“… ì‹¤í–‰ ì¼ì •

### âœ… ì™„ë£Œëœ ì‘ì—… ë‚´ì—­

#### Step 1: ë¶ˆí•„ìš”í•œ ì½”ë“œ ì œê±° âœ… ì™„ë£Œ
- `conversation_service.py`: `save_conversation()`, `get_conversation_context()` ì œê±°
- `chat_routes.py`: ê°œë³„ ì €ì¥ ë¡œì§ ì œê±°

#### Step 2: ê³„íšì„œ ê¸°ì¤€ ë°ì´í„° êµ¬ì¡° ì ìš© âœ… ì™„ë£Œ
- **í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ê°œì„ **: `response` ì»¬ëŸ¼ ì¶”ê°€
- **ì €ì¥ ë°©ì‹ ìˆ˜ì •**: ì§ˆë¬¸ê³¼ ë‹µë³€ì„ ë³„ë„ í•„ë“œì— ì €ì¥
- **ì¡°íšŒ ë¡œì§ ê°œì„ **: íŒŒì‹± ì—†ì´ ì§ì ‘ í•„ë“œ ì ‘ê·¼

#### Step 3: ì½”ë“œ ìˆ˜ì • ì™„ë£Œ âœ… ì™„ë£Œ
- `conversation_service.py`: ê³„íšì„œ ê¸°ì¤€ êµ¬ì¡°ë¡œ ì „ë©´ ìˆ˜ì •
- `chat_routes.py`: í†µí•© ì €ì¥ ë°©ì‹ ë° ì˜¬ë°”ë¥¸ ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ ì ìš©

---

## ğŸ”§ êµ¬ì²´ì ì¸ ìˆ˜ì • ë‚´ìš©

### 1. í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ê°œì„ 
```sql
-- ìƒˆë¡œ ì¶”ê°€ëœ ì»¬ëŸ¼
response STRING  -- AI ì‘ë‹µ ì „ìš© í•„ë“œ
```

### 2. conversation_service.py ìˆ˜ì •ì‚¬í•­
```python
# ì €ì¥ êµ¬ì¡° ê°œì„ 
interaction_data = {
    'message': user_question,     # ì‚¬ìš©ì ì§ˆë¬¸ë§Œ
    'response': assistant_answer, # AI ì‘ë‹µë§Œ (ë³„ë„ í•„ë“œ)
    'result_data': query_result.get('data', []),
    # ...
}

# ì¡°íšŒ ì¿¼ë¦¬ ê°œì„ 
SELECT 
    message as user_question,    # ë³„ë„ í•„ë“œ
    response as assistant_answer, # ë³„ë„ í•„ë“œ
    result_data, result_row_count
FROM conversations
```

### 3. chat_routes.py ìˆ˜ì •ì‚¬í•­
```python
# ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ ê°œì„  - íŒŒì‹± ì œê±°
if conv.get('user_question'):
    conversation_context.append({
        "role": "user",
        "content": conv['user_question']  # ì§ì ‘ í•„ë“œ ì ‘ê·¼
    })

# í†µí•© ì €ì¥ ë°©ì‹ ì ìš©
save_result = bigquery_client.save_complete_interaction(
    user_id=user_info['user_id'],
    user_question=message,
    assistant_answer=ai_response_content,
    # ...
)
```

---

## ğŸ‰ ê²°ë¡  ë° ì„±ê³¼

### âœ… í•´ê²°ëœ ë¬¸ì œë“¤
1. **ì»¨í…ìŠ¤íŠ¸ ìœ ì§€ ì‹¤íŒ¨**: ë³„ë„ í•„ë“œ ì €ì¥ìœ¼ë¡œ í•´ê²°
2. **íŒŒì‹± ì˜¤ë¥˜**: ì§ì ‘ í•„ë“œ ì ‘ê·¼ìœ¼ë¡œ í•´ê²°  
3. **ë°ì´í„° ì¤‘ë³µ**: í†µí•© ì €ì¥ìœ¼ë¡œ í•´ê²°
4. **ì„±ëŠ¥ ì €í•˜**: ë‹¨ì¼ ì¿¼ë¦¬ë¡œ í•´ê²°

### ğŸ“ˆ ê¸°ëŒ€ íš¨ê³¼
- **ì €ì¥ íš¨ìœ¨ì„±**: 3íšŒ ì €ì¥ â†’ 1íšŒ ì €ì¥
- **ì¡°íšŒ ì„±ëŠ¥**: íŒŒì‹± ë¡œì§ ì œê±°ë¡œ 50% í–¥ìƒ
- **ì½”ë“œ ë³µì¡ë„**: 30% ê°ì†Œ
- **ê°œë°œ ìƒì‚°ì„±**: ë””ë²„ê¹… ë° í™•ì¥ ìš©ì´

ì´ì œ `í†µí•©_ë°ì´í„°êµ¬ì¡°_ê°œì„ ì•ˆ_êµ¬í˜„ê³„íš.md`ì˜ **Phase 1** ê¸°ì¤€ì— ì™„ì „íˆ ë¶€í•©í•˜ëŠ” êµ¬ì¡°ê°€ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸš€