# BigQuery 다중 테이블 지원 확장 계획 수립 대화 분석

> **프로젝트**: nlq-v1 (Natural Language Query v1)  
> **분석 목적**: 효과적인 기술 계획 수립을 위한 지시/피드백 방법 연구  
> **작성일**: 2025-09-03  
> **대화 결과**: 10-15일 복잡한 설계 → 3일 단순 확장으로 개선

## 🎯 대화 결과 요약

**최종 성과**: 
- **구현 기간**: 15일 → 3일 (80% 단축)
- **변경 범위**: 새로운 시스템 구축 → 프롬프트 템플릿 + MetaSync 확장만
- **접근법**: 복잡한 테이블 선택 시스템 → LLM이 날짜 조건으로 자동 처리

---

## 💬 실제 대화 재현 & 개선 지시법

### 1️⃣ 첫 번째 라운드: 너무 모호한 지시

#### **실제 대화**
**👤 사용자**: 
> "현재 bigquery 의 nlq-ex.test_dataset.events_ 로 시작하는 테이블이 92개 있다. 테이블들을 유연하게 조회하기 위한 개선 작업 계획을 작성하라."

**🤖 AI 응답**: 
> *완전히 새로운 시스템 설계 제시*
> - 테이블 선택 시스템 구축
> - 개별 캐시 파일 생성  
> - 복잡한 테이블 관리 컴포넌트들
> - 10-15일 구현 계획

#### **🔥 문제점**
- "유연하게 조회"가 너무 추상적
- 기존 시스템 상태나 제약사항 명시 안함
- 원하는 해결책의 방향성 없음

#### **✅ 처음부터 더 나은 지시를 했다면**
**👤 더 나은 초기 지시**: 
```
현재 상황:
- BigQuery에 events_YYYYMMDD 형태 테이블 92개 존재
- 현재는 events_20210131 하나만 하드코딩으로 사용 중
- 모든 events 테이블은 동일한 스키마 구조

문제:
- 다른 날짜의 데이터 조회 불가
- 날짜 범위 쿼리 지원 안됨

원하는 결과:
- LLM이 사용자 질문의 날짜 조건을 파악해서 적절한 테이블 자동 선택
- "2021년 3월 데이터"라고 하면 events_202103* 테이블들 사용
- "1월부터 3월까지"라고 하면 UNION 쿼리 생성

제약사항:
- 기존 LLM 중심 아키텍처는 유지할 것
- 구현 기간은 1주일 이내로 제한
- 복잡한 새 컴포넌트 추가 지양

➡️ 결과: 첫 응답부터 3일짜리 단순한 계획 예상
```

### 2️⃣ 두 번째 라운드: 부분적 피드백의 한계

#### **실제 대화** 
**👤 사용자**: 
> "하위 호환성유지하지 않는다. 테이블이 계속 늘어날것이다. 계획안 업데이트하라."

**🤖 AI 응답**: 
> *여전히 복잡한 새 시스템 유지*
> - 하위 호환성 관련 부분만 제거
> - 근본적인 접근법은 변경 안함

#### **🔥 문제점**
- 피드백이 수정사항 중심이라 전체적 방향 수정 어려움
- AI가 이전 접근법의 문제를 인식하지 못함

#### **✅ 더 나은 두 번째 피드백 전략**
**👤 실시간 대화 이끌기**: 
```
현재 계획의 문제점:
1. 기존 시스템이 이미 LLM 중심으로 잘 설계되어 있는데 새로 만들려고 함
2. events 테이블들이 모두 동일 구조인데 개별 캐시 파일 만들려고 함
3. 단순히 프롬프트에 테이블 목록만 제공하면 될 문제를 너무 복잡하게 접근

올바른 방향:
- 기존 generate_sql() 메서드 그대로 사용
- sql_generation.json 프롬프트에 available_tables 변수만 추가
- MetaSync에서 events_ 패턴 테이블 목록만 수집하도록 확장
- LLM이 알아서 날짜 조건 파악해서 테이블 선택하도록

기대하는 구현 규모: 2-3일 이내, 기존 파일 3-4개만 수정

➡️ 핵심: 근본적인 설계 문제 지적 + 구체적 대안 제시
```

### 3️⃣ 세 번째 라운드: 방향은 맞지만 구체성 부족

#### **실제 대화**
**👤 사용자**: 
> "테이블 선택 시스템을 별도로 만들지 않는다. llm 에게 맥락을 잘 전달하여 알아서 치리하도록한다."

**🤖 AI 응답**: 
> *LLM 중심으로 바꾸긴 했지만 여전히 새 컴포넌트들 추가*
> - LLM 기반 새 서비스들 제안
> - 복잡한 컨텍스트 관리 시스템

#### **🔥 문제점**
- "LLM 활용"이라는 방향은 좋지만 구체적 방법 제시 안함
- 여전히 "기존 시스템 활용"이라는 핵심 메시지 누락

#### **✅ 세 번째 피드백 전략: 구체적 기술 정보 제공**
**👤 실시간 대화 전략**: 
```
기존 시스템 분석:
- features/llm/services.py의 generate_sql() 메서드가 이미 완벽하게 작동중
- sql_generation.json 프롬프트가 이미 LLM에게 스키마 정보 제공중
- MetaSync가 이미 캐시 시스템으로 메타데이터 관리중

필요한 변경사항 (최소한):
1. sql_generation.json에 {events_tables} 변수 하나만 추가
2. MetaSync에서 events_ 패턴 테이블 리스트 수집하는 로직 추가  
3. cache_loader.py에 get_events_tables() 메서드 하나 추가

참고: LLM은 이미 충분히 똑똑해서 "2021년 3월"이라고 하면 events_202103으로 연결할 수 있다.

➡️ 핵심: 기존 시스템의 구체적 파일명 언급 + 3줄 코드 수준의 변경 모드
```

### 4️⃣ 네 번째 라운드: 강력하고 명확한 지시

#### **실제 대화** 
**👤 사용자**: 
> "기존 시스템을 유지하라. 기존 시스템은 llm 을 활용하도록 설계되어 있다. 이를 기반으로 계획하라. 계획안 전면 재검토하라"

**🤖 AI 응답**: 
> *드디어 기존 시스템 분석 시작*
> - LLMService의 5개 메서드 파악
> - ContextBlock 중심 설계 인식
> - 확장 중심 접근으로 전환

#### **✅ 네 번째: 강력한 대전환 지시 타이밍**
**👤 실시간 대화 전략**: 
```
AI가 3번이나 잘못된 방향으로 가고 있을 때 사용할 효과적 패턴:

"기존 시스템을 유지하라. 기존 시스템은 llm을 활용하도록 설계되어 있다. 
이를 기반으로 계획하라. 계획안 전면 재검토하라"

➡️ 핵심 요소:
1. "전면 재검토하라" - 강력한 리셋 명령
2. "기존 시스템은 잘 설계되어 있다" - 전제 조건 명시
3. "이를 기반으로" - 구체적 방향 지시

비슷한 상황에서 사용법:
- AI가 2-3번 잘못된 방향 제시 시 사용
- "전면 재검토" 같은 강력한 리셋 명령
- 기존 시스템의 장점 명시로 방향 전환
```

### 5️⃣ 다섯 번째 라운드: 구체적 제약사항으로 완성도 높이기

#### **실제 대화**
**👤 사용자**: 
> "events 테이블은 동일한 구조이므로 개별 파일을 생성할 필요가 없다. table_selection.json 관련 기능 제거하라. sql_generation를 확장하여 사용하라."

**🤖 AI 응답**: 
> *훨씬 단순한 접근법 제시*
> - 개별 캐시 파일 제거
> - table_selection 완전 제거  
> - sql_generation만 확장

#### **✅ 다섯 번째: 도메인 지식 제공 타이밍**
**👤 실시간 대화 전략**: 
```
AI가 단순화 방향으로 가고 있지만 아직 불필요한 복잡성이 남아있을 때:

"events 테이블은 동일한 구조이므로 개별 파일을 생성할 필요가 없다. 
table_selection.json 관련 기능 제거하라. 
sql_generation을 확장하여 사용하라."

➡️ 핵심 요소:
1. "동일한 구조" - 데이터 특성 지식 직접 제공
2. "table_selection.json 제거" - 구체적 제거 대상 명시
3. "sql_generation 확장" - 대안 제시

언제 사용:
- AI가 올바른 방향으로 가고 있지만 세부적으로 불필요한 복잡성 남아있을 때
- 도메인 지식 직접 제공 + 구체적 대안
```

### 6️⃣ 마지막 라운드: 본질적 통찰 제공

#### **실제 대화**
**👤 사용자**: 
> "현재는 동일한 스키마의 데이터를 날짜별로 분리한구조이다. 이를 참고하여 계획안을 개선하라"

**🤖 AI 응답**: 
> *완전한 이해와 최적화*
> - 날짜별 분리 구조의 본질 파악
> - 모든 불필요 컴포넌트 제거
> - 3일 구현으로 대폭 단축

#### **✅ 여섯 번째: 본질적 통찰 제공 타이밍** 
**👤 실시간 대화 전략**: 
```
AI가 올바른 방향으로 가고 있지만 아직 문제의 본질을 파악하지 못했을 때:

"현재는 동일한 스키마의 데이터를 날짜별로 분리한구조이다. 
이를 참고하여 계획안을 개선하라"

➡️ 핵심 요소:
1. "동일한 스키마" - 데이터 구조의 본질
2. "날짜별로 분리" - 문제의 핵심 특성
3. "이를 참고하여" - 통찰을 활용하라는 명시적 지시

언제 사용:
- AI가 기술적 복잡성에 매몰되어 단순한 해결책을 놓칠 때
- 비즈니스 로직의 단순성을 강조할 필요가 있을 때
- "동일 스키마 + 날짜 분리 = 단순한 문제"라는 통찰 제공
```

---

## 📚 효과적인 지시법 가이드

### 0. **실시간 대화 관리 전략**

#### **🎯 핵심 아이디어**
AI가 잘못된 방향으로 가고 있을 때, **언제** 어떤 종류의 개입을 해야 하는지 타이밍과 방법론

#### **대화 상황별 대응 패턴**
```
1라운드 (너무 모호한 지시) 
→ 2라운드 (부분 수정 시도)
→ 3라운드 (방향은 맞지만 구체성 부족)
→ 4라운드 (강력한 리셋 필요) ← 핵심 전환점
→ 5라운드 (도메인 지식 직접 제공)
→ 6라운드 (본질적 통찰 제공)
```

#### **타이밍별 개입 전략**
- **1-2라운드**: 점진적 수정 시도
- **3라운드**: 구체적 기술 정보 제공
- **4라운드**: 강력한 "전면 재검토" 리셋 (핵심!)
- **5-6라운드**: 도메인 지식과 본질적 통찰 직접 제공

### 1. **초기 지시 시 포함해야 할 요소들**

#### **🔴 피해야 할 모호한 지시**
```
❌ "시스템을 개선해주세요"
❌ "더 유연하게 만들어주세요"  
❌ "확장 가능하게 설계해주세요"
```

#### **🟢 효과적인 구체적 지시**
```
✅ 현재 상황: [구체적 문제 상황]
✅ 기존 시스템: [현재 아키텍처 특징]
✅ 원하는 결과: [구체적 동작 시나리오]
✅ 제약사항: [기간, 복잡도, 호환성]
✅ 금지사항: [하지 말아야 할 것들]
```

### 2. **피드백 시 효과적인 패턴**

#### **문제 지적 + 올바른 방향 제시**
```
현재 계획의 문제점:
1. [구체적 문제1]
2. [구체적 문제2]

올바른 접근법:
1. [대안1 - 구체적 방법]
2. [대안2 - 구체적 방법]

기대하는 결과: [측정 가능한 기준]
```

#### **도메인 지식 직접 제공**
```
중요한 정보:
- 테이블들이 모두 동일한 스키마 구조
- 날짜별로 분리되어 있음
- 기존 LLM이 이미 스키마 정보 활용 중

이 정보를 바탕으로 다시 계획하라.
```

### 3. **단계별 명령어 사용법**

#### **1단계: 현상 분석 강제**
```
"먼저 기존 시스템을 정확히 분석하라"
"현재 아키텍처의 장점과 문제점을 파악하라"
"데이터 구조의 특성을 먼저 이해하라"
```

#### **2단계: 방향 설정**
```
"새로운 시스템이 아닌 기존 시스템 확장으로 접근하라"
"복잡한 해결책보다 단순한 방법을 우선 고려하라"
"구현 기간을 [N]일 이내로 제한하라"
```

#### **3단계: 구체적 제약**
```
"[특정 컴포넌트]는 건드리지 말라"
"[특정 파일]만 수정하여 해결하라"
"새로운 클래스 추가 금지"
```

### 4. **효과적인 대화 진행 전략**

#### **🎯 첫 번째 응답에서 확인할 것들**
- [ ] 기존 시스템 분석을 제대로 했는가?
- [ ] 문제의 본질을 파악했는가?
- [ ] 해결책이 과도하게 복잡하지 않은가?
- [ ] 제약사항을 고려했는가?

#### **🔧 피드백 전략**
1. **방향성 문제** → 강력한 재검토 명령
2. **복잡도 문제** → 구체적 단순화 지시
3. **이해도 문제** → 도메인 지식 직접 제공
4. **세부 사항** → 구체적 수정 요청

### 5. **실무에서 사용할 템플릿**

#### **초기 지시 템플릿**
```
📋 현재 상황:
- [구체적 문제 상황]
- [기존 시스템 특징]

🎯 원하는 결과:
- [구체적 시나리오 1]
- [구체적 시나리오 2]

⚠️ 제약사항:
- 구현 기간: [N]일 이내
- 기존 [컴포넌트] 유지
- [금지사항] 하지 말 것

📐 성공 기준:
- [측정 가능한 기준1]
- [측정 가능한 기준2]
```

#### **피드백 템플릿** 
```
❌ 현재 계획의 문제:
1. [구체적 문제] - [이유]
2. [구체적 문제] - [이유]

💡 핵심 통찰:
[중요한 도메인 지식이나 제약사항]

✅ 올바른 접근:
1. [구체적 대안] 
2. [구체적 대안]

🎯 기대 결과:
[간단명료한 최종 목표]
```

## 🏆 결론: 좋은 지시의 핵심

### **성공한 지시의 공통점**
1. **구체성**: 모호한 표현 배제, 측정 가능한 기준 제시
2. **맥락 제공**: 도메인 지식과 제약사항 명확히 전달
3. **방향성**: 원하는 해결 방향과 접근법 명시
4. **경계 설정**: 금지사항과 제약사항으로 범위 제한

### **대화를 효과적으로 이끄는 방법**
1. **첫 응답 품질 체크**: 방향이 틀렸으면 즉시 강력한 재검토 요구
2. **도메인 지식 직접 제공**: AI가 추론하기 어려운 비즈니스 로직 설명
3. **구체적 제약 제시**: "X는 건드리지 말고 Y만 수정하라"
4. **단계적 접근**: 분석 → 방향 설정 → 구체화 순서로 진행

이런 방식으로 지시했다면 첫 번째 응답부터 3일짜리 단순한 계획을 받을 수 있었을 것입니다.