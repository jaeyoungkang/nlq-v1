# 작업 요약 (2025-08-13)

## 📋 개요

오늘 작업은 애플리케이션의 안정성과 사용자 경험을 향상시키는 데 중점을 두었습니다. 초기 로드 시 발생하던 **인증 경쟁 조건(Race Condition) 문제를 해결**하여 API 호출 안정성을 확보했으며, **데이터베이스 및 외부 API 관련 예외 상황에 대한 방어 코드**를 보강했습니다. 또한, 데이터 저장 로직을 개선하여 보다 의미 있는 대화 기록이 남도록 수정했습니다.

---

### 1. 프론트엔드 인증 경쟁 조건 해결

-   **문제점**: 로그인 직후 또는 페이지 새로고침 시, 대화 기록을 불러오는 API(`GET /api/conversations/latest`)가 인증 토큰이 적용되기 전에 먼저 호출되어 `401 Unauthorized` 오류가 반복적으로 발생했습니다작업요약2_gemini_대화록.md].
-   **해결 방안**:
    1.  **중앙 API 클라이언트 도입**: 모든 API 요청을 관리하는 중앙 Axios 인스턴스(`frontend/src/lib/api.ts`)를 생성했습니다.
    2.  **요청 인터셉터(Request Interceptor) 설정**: API 요청이 서버로 전송되기 전에 항상 쿠키에서 인증 토큰을 읽어 `Authorization` 헤더에 포함시키도록 인터셉터를 설정했습니다.
    3.  **코드 리팩터링**: `useAuth.ts`와 `useConversationRestore.ts` 훅에서 기존의 `axios` 직접 호출을 새로운 중앙 API 클라이언트를 사용하도록 변경하여, 모든 API 호출이 일관된 인증 절차를 거치도록 보장했습니다.

---

### 2. 백엔드 안정성 강화

-   **Anthropic API 과부하 오류 처리**:
    -   **문제점**: 외부 서비스인 Anthropic API 서버가 과부하 상태일 때 `529 Overloaded` 오류가 발생하여 서버가 중단되었습니다.
    -   **해결 방안**: `llm_client.py`에 `anthropic.APIStatusError` 예외 처리 로직을 추가하여, 외부 API의 일시적인 장애 발생 시 서버가 멈추는 대신 "AI 서비스가 일시적으로 요청이 많아 응답할 수 없습니다"와 같은 사용자 친화적인 오류 메시지를 반환하도록 수정했습니다.

-   **`conversations` 테이블 부재 오류 처리**:
    -   **문제점**: 사용자가 처음 서비스를 이용하여 `conversations` 테이블이 아직 생성되지 않았을 때, 대화 기록 조회 API가 `404 Not Found` 오류를 내며 서버가 중단되었습니다.
    -   **해결 방안**: `conversation_service.py`의 `get_latest_conversation` 함수에 `try...except NotFound` 블록을 추가하여, 테이블이 없는 경우 오류 대신 "대화 기록 없음" 상태를 정상적으로 반환하도록 수정했습니다.

---

### 3. 데이터 저장 로직 개선

-   **문제점**: AI가 쿼리를 실행한 경우, `conversations` 테이블의 `message` 컬럼에 쿼리 결과 원본 데이터(JSON)가 그대로 저장되어 가독성이 떨어졌습니다.
-   **해결 방안**: `chat_routes.py`의 AI 응답 저장 로직을 수정하여, 쿼리 결과에 대해서는 "📊 조회 결과: N개의 행이 반환되었습니다."와 같은 자연어 요약 메시지가 저장되도록 변경했습니다.

---

### ✅ 최종 결과

이번 작업을 통해 프론트엔드의 고질적인 인증 오류를 해결하고, 백엔드가 외부 요인(API 과부하, 데이터베이스 상태)에 더 유연하게 대처할 수 있도록 안정성을 크게 향상시켰습니다.